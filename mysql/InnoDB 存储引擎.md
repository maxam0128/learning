# InnoDB 存储引擎



## 7 事务
说到事务，我们先讨论一下一致性模型，简单可以分为以下三类：
 
 * 弱一致性：系统并不保证后续的读操作都会返回最新的更新过的值。系统在数据写入成功之后，不承诺立即可以读到最新写入的值，也不会具体的承诺多久之后可以读到。但会尽可能保证在某个时间级别（比如秒级别）之后，可以让数据达到一致性状态。
 
 * 最终一致性：弱一致性的特定形式。系统保证在没有后续更新的前提下，系统最终返回上一次更新操作的值。在没有故障发生的前提下，不一致窗口的时间主要受通信延迟，系统负载和复制副本的个数影响。DNS是一个典型的最终一致性系统。

 * 强一致性：当更新操作完成之后，任何多个后续进程或者线程的访问都会返回最新的更新过的值。这种是对用户最友好的，就是用户上一次写什么，下一次就保证能读到什么。但是这种实现对性能影响较大。
  
### 7.3 分布式事务

分布式事务指允许多个独立的事务资源参与到一个全局的事务中。InnoDB中要使用分布式事务，隔离级别必须使用Serializable。

#### 7.3.1 两阶段提交

XA 事务由一个或多个资源管理器、一个事务管理器及一个应用程序组成。
 
 * 资源管理器：提供访问事务资源的方法。通常一个数据库就是一个资源管理器。
 * 事务管理器：协调参与全局事务中的各个事务，需要和参与全局事务的所有资源管理器进行通信。
 * 应用程序：定义事务的边界，指定全局事务中的操作。


分布式事务使用两阶段提交的方式。
 
 * 第一阶段：
 	* 资源管理器会询问所有的事务节点，是否可以执行提交操作
 	* 各个事务节点执行准备工作，如：为资源上锁，预留资源，undo/redo log等...
 	* 参与者响应协调者，如果事务的准备工作成功，则回应资源管理者可以提交，否则不能提交
 * 第二阶段：
	* 如果所有事务参与者告诉资源管理器执行commit/rollback操作，如果任何一节点回应不能提交，则所有的节点都要回滚。

与本地事务的不同之处在于，分布式事务需要多一次的prepare操作，待收到所有节点的统一信息后，再进行commit或rollback操作。

两阶段提交带来的问题是，如果在第一阶段参与全局事务的节点和资源管理器之间的通信障碍（可能是参与全局事务的一个节点没有收到信息亦或节点给资源管理器发送了消息，资源管理器没收到），那么需要重试或者当做失败处理。在第二阶段中，正式提交发出后，如果有的事务节点没有收到，或是事务节点发出了commit/rollback信息，资源管理器没有收到，一旦参与者的回应超时，要么重试，要么把参与者标记为问题节点从集群中剔除，来保证服务结点的都是数据一致性的。




  